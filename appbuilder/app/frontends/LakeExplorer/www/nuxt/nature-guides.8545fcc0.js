var x=Object.defineProperty;var b=(i,e,t)=>e in i?x(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>(b(i,typeof e!="symbol"?e+"":e,t),t);import{Y as g}from"./entry.c86999db.js";class m{constructor(e,t,s,o,a){d(this,"isSelected");d(this,"isPossible");d(this,"items",[]);var l;this.spaceIdentifier=e,this.encodedSpace=t,this.imageUrl=s,this.secondaryImageUrl=o,this.matrixFilter=a,this.isSelected=!1,this.isPossible=!0,this.items=(l=a==null?void 0:a.items)==null?void 0:l.filter(p=>{var h;return(h=p.space[this.matrixFilter.uuid])==null?void 0:h.find(u=>u.spaceIdentifier===this.spaceIdentifier)})}select(){this.isPossible&&(this.isSelected=!0,this.matrixFilter.onSelectSpace(this))}deselect(){this.isSelected&&(this.isSelected=!1,this.matrixFilter.onDeselectSpace(this))}onOtherSpaceSelected(e){this.matrixFilter.allowMultipleValues||(this.isSelected=!1)}onOtherSpaceDeselected(e){}onItemsChanged(){this.isPossible=!this.items.every(e=>!e.isVisible)}}class f{constructor(e,t,s="",o="",a=!0,l=!1,p=1,h={},u=!1,c){d(this,"space",[]);d(this,"position",1);d(this,"items",[]);var n;this.uuid=e,this.type=t,this.name=s,this.description=o,this.isVisible=a,this.isRestricted=l,this.weight=p,this.restrictions=h,this.allowMultipleValues=u,this.identificationKey=c,this.items=(n=c==null?void 0:c.children)==null?void 0:n.filter(r=>r.space[this.uuid])}onSelectSpace(e){this.identificationKey.onSelectSpace(this,e),this.space.forEach(t=>{e.spaceIdentifier!==t.spaceIdentifier&&t.onOtherSpaceSelected(e)})}onDeselectSpace(e){this.identificationKey.onDeselectSpace(this,e),this.space.forEach(t=>{e.spaceIdentifier!==t.spaceIdentifier&&t.onOtherSpaceDeselected(e)})}onItemsChanged(){this.space.forEach(e=>e.onItemsChanged())}isIdentificationKeyVisible(e,t){var a;const s=e.spaceIdentifier.split(":")[0];return((a=t.space[this.uuid])==null?void 0:a.filter(l=>l.spaceIdentifier.split(":")[0]===s)).every(l=>this.spaceMatchesReference(e,l))}isMatrixFilterVisible(e,t){const s=e.spaceIdentifier.split(":")[0];return!!t.restrictions[s]&&this.spaceMatchesReference(e,t.restrictions[s])}spaceMatchesReference(e,t){return e.spaceIdentifier===t.spaceIdentifier&&e.encodedSpace===t.encodedSpace}createSpace(e){const t=new m(e.spaceIdentifier,e.encodedSpace,e.imageUrl,e.secondaryImageUrl,this);return this.space.push(t),t}}class N extends f{}class M extends f{spaceMatchesReference(e,t){return e.spaceIdentifier===t.spaceIdentifier&&e.encodedSpace.every((s,o)=>s===t.encodedSpace[o])}}class y extends f{constructor(){super(...arguments);d(this,"encodedSpace",[]);d(this,"currentValue",null);d(this,"currentSpace",null)}setEncodedSpace(t){this.encodedSpace=t}selectSpace(t){var a,l;if(((a=this.currentValue)==null?void 0:a.min)===t.min&&((l=this.currentValue)==null?void 0:l.max)===t.max)return;const s=btoa(`[${t.min},${t.max}]`),o=new m(`${this.uuid}:${s}`,[t.min,t.max],null,null,this);this.currentSpace&&this.onDeselectSpace(this.currentSpace),this.onSelectSpace(o),this.currentSpace=o,this.currentValue=t}spaceMatchesReference(t,s){return t.encodedSpace[1]>=s.encodedSpace[0]&&t.encodedSpace[0]<=s.encodedSpace[1]}}class V extends f{}class U extends f{}class C extends f{}const w={DescriptiveTextAndImagesFilter:N,ColorFilter:M,RangeFilter:y,NumberFilter:V,TextOnlyFilter:U,TaxonFilter:C};class G{constructor(e,t,s,o,a,l,p,h,u){d(this,"matrixFilters",{});d(this,"filteredChildren",[]);d(this,"selectedFilterSpaces",{});d(this,"listeners",{});var c;this.name=e,this.taxon=t,this.children=s,this.identificationMode=o,this.childrenCount=a,this.factSheets=l,this.slug=p,this.overviewImage=h;for(const n in u){const r=u[n],I=w[r.type],S=new I(r.uuid,r.type,r.name,r.description,r.isVisible,r.isRestricted,r.weight,r.restrictions,r.allowMultipleValues,this);r.position&&(S.position=r.position),r.type==="RangeFilter"&&S.setEncodedSpace(r.encodedSpace),(c=r.space)==null||c.forEach(F=>{S.createSpace(F)}),this.matrixFilters[n]=S}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t))}notifyListeners(e,...t){(this.listeners[e]||[]).forEach(s=>{s.call(s,e,this,...t)})}onSelectSpace(e,t){this.selectedFilterSpaces[e.uuid]=t,this.calculateUpdates()}onDeselectSpace(e,t){delete this.selectedFilterSpaces[e.uuid],this.calculateUpdates()}calculateUpdates(){this.calculateFilteredChildren(),this.calculateFilteredMatrixFilters()}calculateFilteredChildren(){this.children.forEach(e=>{e.isVisible=!0;for(const t in this.selectedFilterSpaces)if(t in e.space&&!this.matrixFilters[t].isIdentificationKeyVisible(this.selectedFilterSpaces[t],e)){e.isVisible=!1;break}}),this.notifyListeners("childrenUpdated",this.children)}calculateFilteredMatrixFilters(){Object.values(this.matrixFilters).forEach(e=>{e.isVisible=!0;for(const t in this.selectedFilterSpaces)if(t in e.space&&!this.matrixFilters[t].isMatrixFilterVisible(this.selectedFilterSpaces[t],e)){e.isVisible=!1;break}e.onItemsChanged()}),this.notifyListeners("filterUpdated",this.matrixFilters)}get visibleChildren(){return Object.values(this.children).filter(e=>e.isVisible)}}class R{constructor(e,t,s,o,a,l,p,h,u,c){d(this,"tree",{});this.uuid=e,this.version=t,this.options=s,this.globalOptions=o,this.name=a,this.crossLinks=l,this.startNodeUuid=p,this.isMulticontent=h,this.slugs=u;for(const n in c)this.tree[n]=new G(c[n].name,c[n].taxon,c[n].children,c[n].identificationMode,c[n].childrenCount,c[n].factSheets,c[n].slug,c[n].overviewImage,c[n].matrixFilters)}getIdentificationKey(e){return this.tree[e]||null}}const v=g("natureGuide",{state:()=>({natureGuide:null,currentNode:null,currentNodeId:""}),getters:{currentNodeIsRootNode:i=>{var e;return i.currentNodeId===((e=i.natureGuide)==null?void 0:e.startNodeUuid)}},actions:{async loadNatureGuide(i){var s;if(((s=this.natureGuide)==null?void 0:s.uuid)===i)return;const t=await(await fetch(`/localcosmos/features/NatureGuide/${i}/${i}.json`)).json();this.natureGuide=new R(t.uuid,t.version,t.options,t.globalOptions,t.name,t.crossLinks,t.startNodeUuid,t.isMulticontent,t.slugs,t.tree),this.loadNode(this.natureGuide.startNodeUuid)},loadNode(i){this.currentNodeId=i,this.currentNode=this.natureGuide.getIdentificationKey(i),this.currentNode.calculateUpdates()},loadNodeBySlug(i){const e=this.natureGuide.slugs[i];this.loadNode(e)}}});export{v as u};
