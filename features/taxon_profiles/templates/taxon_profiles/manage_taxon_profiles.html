{% extends 'app_kit/manage_generic_content.html' %}
{% load i18n localcosmos_tags taxon_profile_tags app_tags %}

{% block generic_content_specific %}

	<div class="card">
		<div class="card-body">
			<h4 class="card-title">{% trans 'Create your taxon profiles' %}</h4>
			<div>{% trans 'Type the name of the taxon you want to manage the profile for or select a taxon from your nature guides.' %}</div>
			<form>
				<div class="form-group">
					{{ searchbackboneform }}
				</div>
			</form>
			<hr>
			<h5>{% trans 'Taxa from nature guides' %}</h5>
			<div>
				{% for entry in nature_guide_results %}
					<div>
						<h5>{{ entry.nature_guide }}</h5>
						{% url 'get_nature_guide_taxonprofile_page' meta_app.id content_type.id generic_content.id entry.nature_guide.id as pagination_url %}
						<div id="ng_taxonlist_{{ entry.nature_guide.id }}" class="endless_page_template">
							{% with nature_guide=entry.nature_guide results=entry.results %}
								{% include 'taxon_profiles/ajax/nature_guide_taxonlist.html' %}
							{% endwith %}
						</div>
					</div>
				{% endfor %}
			</div>
			<h5>
				{% trans 'Taxon Profiles with no occurrence in any nature guide' %}
				{% get_generic_content_option generic_content 'include_only_taxon_profiles_from_nature_guides' as ng_only %}
				{% if ng_only %}
					({% trans 'not included in app' %})
				{% endif %}
			</h5>
			
			<div id="non_ng_taxa" class="endless_page_template">
				{% include 'taxon_profiles/ajax/non_nature_guide_taxonlist.html' %}
			</div>
		</div>
	</div>

{% endblock %}

{% block extra_script %}

	<script>
		
		var get_manage_or_create_baseurl = "{% url 'get_taxon_profiles_manage_or_create_url' meta_app.id generic_content.id %}";

		var taxon_source_input = document.getElementById("id_taxon_0");
		var taxon_latname_input = document.getElementById("id_taxon_1");
		var taxon_author_input = document.getElementById("id_taxon_2")
		var name_uuid_input = document.getElementById("id_taxon_3")

		name_uuid_input.addEventListener("change", function(event){

			if (taxon_source_input.value && name_uuid_input.value){
				// create taxon profile or manage taxon profile?
				// currently name_uuid is used. maybe use latname&author - what happens if a taxon DB gets updated with name_uuid?
				// var url = base_url + '?taxon_source=' + source_input.value + '&taxon_latname=' + taxon_latname_input.value + '&taxon_author=' + encodeURIComponent(taxon_author_input.value);
				var determineURL_url = get_manage_or_create_baseurl + '?taxon_source=' + taxon_source_input.value + '&name_uuid=' + name_uuid_input.value;
				$.get(determineURL_url, function(data){
					if (typeof data == "object"){
						window.location = data.url;
					}
				}); 
				
			}
		});
		{% for entry in nature_guide_results %}
			$('#ng_taxonlist_{{ entry.nature_guide.id }}').endlessPaginate();
		{% endfor %}
		$('#non_ng_taxa').endlessPaginate();
	</script>

{% endblock %}
